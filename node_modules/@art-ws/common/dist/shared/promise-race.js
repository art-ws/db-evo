"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.synchronized = exports.racePromise = void 0;
const localCache = {};
// https://developer.mozilla.org/ru/docs/Web/JavaScript/Reference/Global_Objects/Promise/race
function racePromise(keyFn, fnOrThenable, scope) {
    const cache = scope || localCache;
    let key = (keyFn.apply && keyFn.call
        ? keyFn()
        : keyFn) || "";
    if (!key)
        throw new Error("key is empty");
    key = `$racePromise_${key}`;
    if (cache[key]) {
        return cache[key];
    }
    const promise = typeof fnOrThenable.then === "function"
        ? fnOrThenable
        : fnOrThenable();
    if (!promise)
        throw new Error("promise not defined");
    cache[key] = promise;
    const done = () => {
        delete cache[key];
    };
    promise.then(done, done);
    return promise;
}
exports.racePromise = racePromise;
function synchronized(syncKey, scope) {
    return (fn) => {
        const key = `$synchronized_${syncKey}`;
        if (scope[key])
            return scope[key];
        const promise = fn();
        scope[key] = promise;
        const done = () => delete scope[key];
        promise.then(done, done);
        return promise;
    };
}
exports.synchronized = synchronized;
//# sourceMappingURL=promise-race.js.map